# 码客邦 (MaKeBang) 技术架构文档

## 1. 项目概述

### 1.1 项目背景
码客邦是一个面向中国国内市场的程序员接单平台，类似于Freelancer，旨在连接有软件开发需求的企业/个人与专业程序员，实现需求发布、接单、交付、支付的全流程闭环。

### 1.2 项目目标
- 为需求方提供便捷的项目发布和管理平台
- 为程序员提供优质的接单和展示平台
- 建立安全可靠的交易担保机制
- 构建程序员技能评价和信用体系

### 1.3 项目阶段
| 阶段 | 内容 | 平台 |
|------|------|------|
| 第一阶段 | MVP版本 | Web网站 |
| 第二阶段 | 功能完善 | Web + 微信小程序 |
| 第三阶段 | 全平台 | Web + 小程序 + iOS/Android APP |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                 │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   Web (React)   │  小程序 (Taro)  │    APP (React Native)       │
└────────┬────────┴────────┬────────┴──────────────┬──────────────┘
         │                 │                       │
         └─────────────────┼───────────────────────┘
                           │
                    ┌──────▼──────┐
                    │   Nginx     │
                    │  负载均衡    │
                    └──────┬──────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────▼────┐      ┌─────▼─────┐    ┌─────▼─────┐
    │ Gateway │      │  Gateway  │    │  Gateway  │
    │   节点1  │      │   节点2   │    │   节点N   │
    └────┬────┘      └─────┬─────┘    └─────┬─────┘
         │                 │                 │
         └─────────────────┼─────────────────┘
                           │
              ┌────────────┼────────────┐
              │            │            │
        ┌─────▼─────┐ ┌────▼────┐ ┌─────▼─────┐
        │用户服务    │ │项目服务  │ │ 订单服务   │
        │           │ │         │ │           │
        └─────┬─────┘ └────┬────┘ └─────┬─────┘
              │            │            │
        ┌─────▼─────┐ ┌────▼────┐ ┌─────▼─────┐
        │消息服务    │ │支付服务  │ │ 评价服务   │
        └─────┬─────┘ └────┬────┘ └─────┬─────┘
              │            │            │
              └────────────┼────────────┘
                           │
    ┌──────────────────────┼──────────────────────┐
    │                      │                      │
┌────▼────┐  ┌───────┐  ┌────▼────┐  ┌─────────┐  ┌──▼──┐
│PostgreSQL│  │ Redis │  │   ES    │  │   OSS   │  │ MQ  │
└─────────┘  └───────┘  └─────────┘  └─────────┘  └─────┘
```

### 2.2 技术架构分层

```
┌─────────────────────────────────────────────────────────┐
│  表现层 (Presentation Layer)                            │
│  - React 18 + TypeScript                               │
│  - Ant Design Pro                                      │
│  - Redux Toolkit                                       │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│  网关层 (Gateway Layer)                                 │
│  - Spring Cloud Gateway                                │
│  - JWT认证 + OAuth2.0                                  │
│  - 限流/熔断                                            │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│  业务层 (Business Layer)                                │
│  - Spring Boot 3.x                                     │
│  - Spring Security                                     │
│  - MyBatis-Plus                                        │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────┐
│  数据层 (Data Layer)                                    │
│  - PostgreSQL 16 (主数据库)                            │
│  - pgvector (向量存储/AI检索)                          │
│  - Redis 7.x (缓存/会话)                               │
│  - Elasticsearch (搜索引擎)                            │
│  - 阿里云OSS (文件存储)                                 │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 技术选型

### 3.1 后端技术栈

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 开发框架 | Spring Boot | 3.2.x | 主框架 |
| 微服务 | Spring Cloud | 2023.x | 微服务架构(后期) |
| 安全框架 | Spring Security | 6.x | 认证授权 |
| ORM框架 | MyBatis-Plus | 3.5.x | 数据持久化 |
| 数据库 | PostgreSQL | 16.x | 主数据库，支持pgvector |
| 缓存 | Redis | 7.x | 缓存/分布式锁 |
| 搜索引擎 | Elasticsearch | 8.x | 全文检索 |
| 消息队列 | RabbitMQ | 3.12 | 异步消息 |
| 对象存储 | 阿里云OSS | - | 文件存储 |
| 接口文档 | Knife4j | 4.x | API文档 |
| 工具库 | Hutool | 5.8.x | 工具集 |

### 3.2 前端技术栈

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 框架 | React | 18.x | UI框架 |
| 语言 | TypeScript | 5.x | 类型安全 |
| 构建工具 | Vite | 5.x | 构建打包 |
| UI组件 | Ant Design | 5.x | 组件库 |
| 状态管理 | Redux Toolkit | 2.x | 状态管理 |
| 路由 | React Router | 6.x | 前端路由 |
| HTTP客户端 | Axios | 1.x | 网络请求 |
| 样式方案 | TailwindCSS | 3.x | 原子化CSS |
| 图表 | ECharts | 5.x | 数据可视化 |

### 3.3 DevOps技术栈

| 类别 | 技术 | 说明 |
|------|------|------|
| 容器 | Docker | 容器化部署 |
| 编排 | Docker Compose / K8s | 容器编排 |
| CI/CD | Jenkins / GitHub Actions | 持续集成 |
| 代理 | Nginx | 反向代理/负载均衡 |
| 监控 | Prometheus + Grafana | 系统监控 |
| 日志 | ELK Stack | 日志收集分析 |

---

## 4. 功能模块设计

### 4.1 核心模块

```
码客邦
├── 用户模块 (user-service)
│   ├── 用户注册/登录
│   ├── 实名认证
│   ├── 个人资料管理
│   ├── 程序员技能认证
│   └── 信用体系
│
├── 项目模块 (project-service)
│   ├── 需求发布
│   ├── 需求分类
│   ├── 需求搜索
│   ├── 项目管理
│   └── 里程碑管理
│
├── 订单模块 (order-service)
│   ├── 投标/竞标
│   ├── 订单创建
│   ├── 订单状态流转
│   ├── 交付验收
│   └── 争议处理
│
├── 支付模块 (payment-service)
│   ├── 担保交易
│   ├── 支付宝/微信支付
│   ├── 资金托管
│   ├── 结算提现
│   └── 发票管理
│
├── 消息模块 (message-service)
│   ├── 站内信
│   ├── 即时通讯
│   ├── 系统通知
│   └── 短信/邮件通知
│
├── 评价模块 (review-service)
│   ├── 双向评价
│   ├── 评分体系
│   └── 信用计算
│
└── 后台管理模块 (admin-service)
    ├── 用户管理
    ├── 内容审核
    ├── 订单管理
    ├── 数据统计
    └── 系统配置
```

### 4.2 用户角色

| 角色 | 说明 | 核心功能 |
|------|------|----------|
| 需求方 | 发布项目需求的企业/个人 | 发布需求、选择开发者、验收项目 |
| 程序员 | 接单的开发者 | 浏览需求、投标竞价、交付项目 |
| 平台管理员 | 后台运营人员 | 审核、管理、统计 |

### 4.3 核心业务流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 需求发布  │────▶│ 程序员投标│────▶│ 选择中标  │────▶│ 托管付款  │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                                                        │
┌──────────┐     ┌──────────┐     ┌──────────┐         │
│ 交易完成  │◀────│ 确认验收  │◀────│ 项目交付  │◀────────┘
└──────────┘     └──────────┘     └──────────┘
      │
      ▼
┌──────────┐
│ 双向评价  │
└──────────┘
```

---

## 5. 数据库设计

### 5.1 PostgreSQL 选型理由

| 特性 | 说明 | Agent应用场景 |
|------|------|---------------|
| pgvector | 向量数据类型和相似性搜索 | 语义搜索、RAG检索、技能匹配 |
| JSONB | 高效的JSON存储和查询 | Agent对话历史、工具调用记录 |
| 全文搜索 | 内置中文分词支持(zhparser) | 需求搜索、程序员搜索 |
| 扩展性 | 丰富的扩展生态 | 未来AI功能集成 |

### 5.2 核心数据表

```sql
-- 启用扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "vector";  -- pgvector向量扩展

-- 用户表
CREATE TABLE "user" (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE,
    email VARCHAR(100) UNIQUE,
    avatar VARCHAR(500),
    user_type SMALLINT DEFAULT 0,  -- 0:需求方 1:程序员 2:两者
    real_name VARCHAR(50),
    id_card VARCHAR(20),
    status SMALLINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 程序员资料表
CREATE TABLE developer_profile (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES "user"(id),
    skills JSONB,  -- 技能标签JSON数组
    experience_years SMALLINT,
    hourly_rate DECIMAL(10,2),
    portfolio JSONB,  -- 作品集
    bio TEXT,
    github_url VARCHAR(255),
    certification_status SMALLINT DEFAULT 0,
    credit_score DECIMAL(5,2) DEFAULT 100.00,
    skill_embedding VECTOR(1536),  -- 技能向量(用于AI匹配)
    UNIQUE(user_id)
);

-- 项目/需求表
CREATE TABLE project (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES "user"(id),
    title VARCHAR(200) NOT NULL,
    description TEXT,
    category_id INTEGER,
    budget_min DECIMAL(12,2),
    budget_max DECIMAL(12,2),
    deadline DATE,
    skill_requirements JSONB,
    attachment_urls JSONB,
    status SMALLINT DEFAULT 0,
    view_count INTEGER DEFAULT 0,
    bid_count INTEGER DEFAULT 0,
    content_embedding VECTOR(1536),  -- 需求向量(用于AI匹配)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 投标表
CREATE TABLE bid (
    id BIGSERIAL PRIMARY KEY,
    project_id BIGINT REFERENCES project(id),
    developer_id BIGINT REFERENCES "user"(id),
    proposed_price DECIMAL(12,2),
    proposed_days INTEGER,
    proposal TEXT,
    status SMALLINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 订单表
CREATE TABLE "order" (
    id BIGSERIAL PRIMARY KEY,
    project_id BIGINT REFERENCES project(id),
    employer_id BIGINT REFERENCES "user"(id),
    developer_id BIGINT REFERENCES "user"(id),
    amount DECIMAL(12,2),
    status SMALLINT DEFAULT 0,
    milestone_count INTEGER DEFAULT 1,
    started_at TIMESTAMP,
    deadline DATE,
    completed_at TIMESTAMP
);

-- 里程碑表
CREATE TABLE milestone (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES "order"(id),
    title VARCHAR(200),
    description TEXT,
    amount DECIMAL(12,2),
    sequence INTEGER,
    status SMALLINT DEFAULT 0,
    due_date DATE,
    completed_at TIMESTAMP
);

-- 支付记录表
CREATE TABLE payment (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES "order"(id),
    payer_id BIGINT REFERENCES "user"(id),
    amount DECIMAL(12,2),
    payment_method VARCHAR(20),
    transaction_no VARCHAR(100),
    status SMALLINT DEFAULT 0,
    paid_at TIMESTAMP
);

-- 评价表
CREATE TABLE review (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT REFERENCES "order"(id),
    reviewer_id BIGINT REFERENCES "user"(id),
    reviewee_id BIGINT REFERENCES "user"(id),
    rating SMALLINT,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 消息表
CREATE TABLE message (
    id BIGSERIAL PRIMARY KEY,
    sender_id BIGINT REFERENCES "user"(id),
    receiver_id BIGINT REFERENCES "user"(id),
    content TEXT,
    msg_type VARCHAR(20),
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Agent对话历史表(为未来Agent功能预留)
CREATE TABLE agent_conversation (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES "user"(id),
    session_id UUID DEFAULT uuid_generate_v4(),
    messages JSONB,  -- 对话消息数组
    context JSONB,   -- 上下文信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建向量索引(用于AI相似性搜索)
CREATE INDEX idx_developer_skill_embedding ON developer_profile
    USING ivfflat (skill_embedding vector_cosine_ops) WITH (lists = 100);

CREATE INDEX idx_project_content_embedding ON project
    USING ivfflat (content_embedding vector_cosine_ops) WITH (lists = 100);
```

### 5.3 索引设计原则
- 主键使用 BIGSERIAL 自增
- 向量字段使用 IVFFlat 索引加速相似性搜索
- JSONB字段使用GIN索引支持高效查询
- 为常用查询字段建立B-tree索引
- 使用软删除(deleted_at)
- 所有表包含created_at, updated_at字段

---

## 6. API设计规范

### 6.1 RESTful API规范

```
基础路径: /api/v1

用户模块:
POST   /api/v1/auth/register     # 注册
POST   /api/v1/auth/login        # 登录
GET    /api/v1/users/me          # 当前用户信息
PUT    /api/v1/users/me          # 更新用户信息

项目模块:
POST   /api/v1/projects          # 发布项目
GET    /api/v1/projects          # 项目列表
GET    /api/v1/projects/{id}     # 项目详情
PUT    /api/v1/projects/{id}     # 更新项目
DELETE /api/v1/projects/{id}     # 删除项目

投标模块:
POST   /api/v1/projects/{id}/bids    # 提交投标
GET    /api/v1/projects/{id}/bids    # 投标列表
PUT    /api/v1/bids/{id}/accept      # 接受投标

订单模块:
GET    /api/v1/orders            # 订单列表
GET    /api/v1/orders/{id}       # 订单详情
PUT    /api/v1/orders/{id}/deliver   # 交付
PUT    /api/v1/orders/{id}/accept    # 验收
```

### 6.2 响应格式

```json
{
    "code": 200,
    "message": "success",
    "data": {
        // 业务数据
    },
    "timestamp": 1703836800000
}
```

### 6.3 错误码设计

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
| 1001 | 用户名已存在 |
| 1002 | 手机号已注册 |
| 2001 | 项目不存在 |
| 3001 | 订单状态不正确 |

---

## 7. 安全设计

### 7.1 认证授权
- JWT Token认证
- 支持微信/支付宝OAuth登录
- 基于RBAC的权限控制
- Token刷新机制

### 7.2 数据安全
- HTTPS全站加密
- 敏感数据加密存储(AES)
- 密码BCrypt加密
- SQL注入防护
- XSS攻击防护

### 7.3 交易安全
- 资金担保托管
- 第三方支付渠道
- 操作日志审计
- 异常交易监控

### 7.4 接口安全
- 接口签名验证
- 防重放攻击(时间戳+nonce)
- 接口限流(令牌桶算法)
- IP黑白名单

---

## 8. 部署架构

### 8.1 开发环境
```
本地开发 → Git推送 → 开发服务器自动部署
```

### 8.2 生产环境

```
┌─────────────────────────────────────────────────────────┐
│                    阿里云 / 腾讯云                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────┐    ┌─────────────────────────────┐        │
│  │   CDN   │    │         负载均衡(SLB)        │        │
│  └────┬────┘    └──────────────┬──────────────┘        │
│       │                        │                       │
│       │         ┌──────────────┼──────────────┐        │
│       │         │              │              │        │
│       │    ┌────▼────┐   ┌─────▼─────┐  ┌─────▼─────┐  │
│       │    │ Web服务1 │   │  Web服务2 │  │  Web服务N │  │
│       │    └────┬────┘   └─────┬─────┘  └─────┬─────┘  │
│       │         │              │              │        │
│       │         └──────────────┼──────────────┘        │
│       │                        │                       │
│  ┌────▼─────────────────────────▼─────────────────┐    │
│  │                   内网环境                       │    │
│  │  ┌──────────┐ ┌───────┐ ┌────────┐ ┌────────┐ │    │
│  │  │PostgreSQL│ │ Redis │ │   ES   │ │  MQ    │ │    │
│  │  │   主从   │ │ 集群  │ │  集群  │ │        │ │    │
│  │  └──────────┘ └───────┘ └────────┘ └────────┘ │    │
│  └───────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 8.3 Docker部署示例

```yaml
# docker-compose.yml
version: '3.8'
services:
  makebang-backend:
    build: ./makebang-backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    depends_on:
      - postgres
      - redis

  makebang-frontend:
    build: ./makebang-frontend
    ports:
      - "80:80"

  postgres:
    image: pgvector/pgvector:pg16  # 包含pgvector扩展的PostgreSQL
    environment:
      POSTGRES_DB: makebang
      POSTGRES_USER: makebang
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

---

## 9. 项目目录结构

```
makebang/
├── docs/                          # 文档目录
│   ├── api/                       # API文档
│   ├── design/                    # 设计文档
│   └── database/                  # 数据库文档
│
├── makebang-backend/              # 后端项目
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/com/makebang/
│   │   │   │   ├── config/        # 配置类
│   │   │   │   ├── controller/    # 控制器
│   │   │   │   ├── service/       # 服务层
│   │   │   │   │   └── impl/      # 服务实现
│   │   │   │   ├── repository/    # 数据访问层
│   │   │   │   ├── entity/        # 实体类
│   │   │   │   ├── dto/           # 数据传输对象
│   │   │   │   ├── vo/            # 视图对象
│   │   │   │   ├── common/        # 公共模块
│   │   │   │   │   ├── exception/ # 异常处理
│   │   │   │   │   ├── result/    # 统一返回
│   │   │   │   │   ├── constant/  # 常量
│   │   │   │   │   └── utils/     # 工具类
│   │   │   │   ├── security/      # 安全模块
│   │   │   │   └── aspect/        # 切面
│   │   │   └── resources/
│   │   │       ├── mapper/        # MyBatis映射
│   │   │       ├── application.yml
│   │   │       └── application-dev.yml
│   │   └── test/                  # 测试
│   └── pom.xml
│
├── makebang-frontend/             # 前端项目
│   ├── src/
│   │   ├── api/                   # API接口
│   │   ├── assets/                # 静态资源
│   │   │   ├── images/
│   │   │   └── styles/
│   │   ├── components/            # 组件
│   │   │   ├── common/            # 通用组件
│   │   │   ├── layout/            # 布局组件
│   │   │   └── business/          # 业务组件
│   │   ├── hooks/                 # 自定义Hook
│   │   ├── pages/                 # 页面
│   │   │   ├── home/
│   │   │   ├── auth/
│   │   │   ├── project/
│   │   │   ├── user/
│   │   │   ├── order/
│   │   │   └── message/
│   │   ├── router/                # 路由配置
│   │   ├── store/                 # 状态管理
│   │   │   └── slices/
│   │   ├── utils/                 # 工具函数
│   │   ├── types/                 # 类型定义
│   │   └── constants/             # 常量
│   ├── package.json
│   └── vite.config.ts
│
├── makebang-common/               # 公共模块
│
├── deploy/                        # 部署配置
│   ├── docker/
│   ├── k8s/
│   └── nginx/
│
└── README.md
```

---

## 10. 后续扩展规划

### 10.1 微信小程序
- 使用Taro框架，复用React组件逻辑
- 微信登录集成
- 小程序支付

### 10.2 移动APP
- React Native跨平台开发
- 推送通知(极光/个推)
- APP内支付

### 10.3 功能扩展
- AI智能匹配(需求方-程序员)
- 在线协作工作台
- 代码托管集成
- 技能考试认证
- VIP会员体系

---

## 11. 开发规范

### 11.1 代码规范
- 后端: 阿里巴巴Java开发手册
- 前端: ESLint + Prettier

### 11.2 Git规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建/工具
```

### 11.3 分支管理
- main: 主分支，生产环境
- develop: 开发分支
- feature/*: 功能分支
- hotfix/*: 紧急修复

---

**文档版本**: v1.0
**更新日期**: 2024年12月
**编写人**: 码客邦技术团队
